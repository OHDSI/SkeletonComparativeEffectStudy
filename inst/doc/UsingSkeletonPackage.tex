\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Using the package skeleton for comparative effectiveness studies},
            pdfauthor={Martijn J. Schuemie},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Using the package skeleton for comparative effectiveness studies}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Martijn J. Schuemie}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{2018-08-24}


\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

This vignette describes how one can use the package skeleton for
comparative effect studies to create one's own study package. This
skeleton is aimed at comparative effectiveness studies using the
\texttt{CohortMethod} package. The resulting package can be used to
execute the study at any site that has access to an observational
database in the Common Data Model. It will perform the following steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Instantiate all cohorts needed for the study in a study-specific
  cohort table.
\item
  Additional cohorts for negative controls will also be created.
\item
  (optional) Positive controls will be synthesized, based on the
  negative controls and pre-specified target effect sizes.
\item
  The main analysis will be executed using the \texttt{CohortMethod}
  package, including fitting of propensity models, adjusting for the
  propensity scores, and fitting outcome models.
\item
  Study diagnostics will be generated while staying blinded to the
  outcome(s) of interest.
\item
  Once the study design is finalized (based on the study diagnostics),
  the results for the outcomes of interest will be generated.
\end{enumerate}

The package skeleton currently implements an examplar study, examining
the effect of celecoxib versus diclofenac on gastrointestinal (GI)
bleeding. If desired (as a test), one can run the package as is. To run
the study, simply run the \texttt{execute} function in the package. See
the R help system for details:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(SkeletonComparativeEffectStudy)}
\NormalTok{?execute}
\end{Highlighting}
\end{Shaded}

\hypertarget{extrascodetorun.r}{%
\subsection{extras/CodeToRun.R}\label{extrascodetorun.r}}

Note that for debugging purposes the package developer (you) could story
the code for running the study package in your environment in the file
called \texttt{CodeToRun.R} in the \texttt{extras} folder.

\hypertarget{extraspackagemaintenance.r}{%
\subsection{extras/PackageMaintenance.R}\label{extraspackagemaintenance.r}}

This file contains other useful code to be used only by the package
developer (you), such as code to generate the package manual, and code
to insert cohort definitions into the package. All statements in this
file assume the current working directory is set to the root of the
package.

Below is the list of steps needed to adapt the package skeleton to
implement another study:

\hypertarget{copy-and-rename-the-package}{%
\section{Copy and rename the
package}\label{copy-and-rename-the-package}}

Please copy the \texttt{SkeletonComparativeEffectStudy} folder. Choose a
name for your study package, and change all references from
`SkeletonComparativeEffectStudy' to your name of choice in the package
code. You could use Notepad++`s 'Find in files' option to do this
automatically.

Also, the DESCRIPTION file contains general information about the
package, including its authors and a description, so don't forget to
update that.

\hypertarget{inserting-the-cohorts-of-interest}{%
\section{Inserting the cohorts of
interest}\label{inserting-the-cohorts-of-interest}}

We will assume that the cohorts of interest, specifically the target,
comparator, and outcome cohorts, have been defined in ATLAS. These
cohort definitions will need to be brought into the study package, so
they are available when someone at a different site, who may not have
access to the same ATLAS instance, wants to run the study.

First, the cohorts that need to be created need to be listed in the file
\texttt{inst/settings/CohortsToCreate.csv}. This is a comma-separated
file with three columns:

\begin{itemize}
\tightlist
\item
  \emph{cohortId}: An integer ID to identify the cohort throughout the
  study package. This could be the same as the ID used in ATLAS, but
  doesn't have to be.
\item
  \emph{atlasId}: The integer ID of the cohort definition in ATLAS.
\item
  \emph{name}: A short name for the cohort. This name is used to create
  the various file names, so do not use special characters etc. in the
  name.
\end{itemize}

Next, we can run the following code, which can also be found in
\texttt{PackageMaintenance.R}. The baseUrl needs to point to the WebAPI
where the cohort definitions are located. The package name needs to be
changed to the name you selected:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Insert cohort definitions from ATLAS into package -----------------------}
\NormalTok{OhdsiRTools}\OperatorTok{::}\KeywordTok{insertCohortDefinitionSetInPackage}\NormalTok{(}\DataTypeTok{fileName =} \StringTok{"CohortsToCreate.csv"}\NormalTok{,}
                                                \DataTypeTok{baseUrl =} \KeywordTok{Sys.getenv}\NormalTok{(}\StringTok{"baseUrl"}\NormalTok{),}
                                                \DataTypeTok{insertTableSql =} \OtherTok{TRUE}\NormalTok{,}
                                                \DataTypeTok{insertCohortCreationR =} \OtherTok{TRUE}\NormalTok{,}
                                                \DataTypeTok{generateStats =} \OtherTok{FALSE}\NormalTok{,}
                                                \DataTypeTok{packageName =} \StringTok{"SkeletonComparativeEffectStudy"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

This code will fetch the cohort definitions from the WebAPI instance,
and will insert them as json files in the \texttt{inst/cohorts} folder.
It will also create corresponding sql files in the \texttt{inst/sql}
folder.

\hypertarget{defining-negative-control-outcomes.}{%
\section{Defining negative control
outcomes.}\label{defining-negative-control-outcomes.}}

We will assume that a set of negative control outcomes have been defined
as a set of concept IDs, with one concept ID per negative control. These
negative controls need to be specified in a file called
\texttt{inst/settings/NegativeControls.csv}. This is a comma-separated
file with the following columns:

\begin{itemize}
\tightlist
\item
  \emph{targetId}: The ID of the target cohort as defined in the
  \texttt{CohortsToCreate.csv} file.
\item
  \emph{targetName}: A name for the target cohort. This is not used
  anywhere, it is just there for convencience.
\item
  \emph{comparatorId}: The ID of the comparator cohort as defined in the
  \texttt{CohortsToCreate.csv} file.
\item
  \emph{comparatorName}: A name for the comparator cohort. This is not
  used anywhere, it is just there for convencience.
\item
  \emph{outcomeId}: The concept ID of the negative control outcome.
\item
  \emph{outcomeName}: A name for the negative control. This is not used
  anywhere, it is just there for convencience.
\item
  \emph{type}: Can be \texttt{Outcome} for negative control outcomes,
  and \texttt{Exposure} for negative control exposures. Currently, only
  negative control outcomes are supported.
\end{itemize}

The reason why for each negative control the target and comparator need
to be specified is twofold: First, if multiple target-comparator pairs
are investigated in a single study, it may be that not all negative
control outcomes are applicable to all target-comparators. Second, in
the future we will support negative control exposures, which can then be
specified in the same file.

We also need logic to convert the concept IDs into cohorts. This logic
is defined in the file \texttt{inst/sql/NegativeControlOutcomes.sql}.
The default logic simply creates a cohort for every occurrence of the
concept ID or any of its descendants in the condition era table. If
other logic is required the SQL file can be modified. Be sure to use
template SQL as expected by the \texttt{SqlRender} package.

\hypertarget{define-the-target-comparator-outcomes-of-interest}{%
\section{Define the target-comparator-outcomes of
interest}\label{define-the-target-comparator-outcomes-of-interest}}

In a single study it is possible to examine multiple
target-compartor-outcome triplets. These should be specified in the
\texttt{inst/settings/TcosOfInterest.csv} file, which has one row per
unique target-comparator pair, so could include multiple outcomes per
row. his is a comma-separated file with the following columns:

\begin{itemize}
\tightlist
\item
  \emph{targetId}: The ID of the target cohort as defined in the
  \texttt{CohortsToCreate.csv} file.
\item
  \emph{targetName}: A name for the target cohort. This name is used to
  generate output tables and figures, so should be `pretty'.
\item
  \emph{comparatorId}: The ID of the comparator cohort as defined in the
  \texttt{CohortsToCreate.csv} file.
\item
  \emph{comparatorName}: A name for the comparator cohort. This name is
  used to generate output tables and figures, so should be `pretty'.
\item
  \emph{outcomeIds}: The IDs of the outcome cohorts as defined in the
  \texttt{CohortsToCreate.csv} file. Multiple IDs should be separated
  using semicolons (;).
\item
  \emph{outcomeNames}: The names of the outcome cohorts. Multiple names
  should be separated using semicolons (;).These name are used to
  generate output tables and figures, so should be `pretty'.
\item
  \emph{excludedCovariateConceptIds}: A list of concept IDs to exclude
  from the covariates. For example, the concept IDs defining the
  exposures of interest should typically be excluded and should be
  listed here. Descendant concepts are automaticaly excluded as well.
  Multiple IDs should be separated using semicolons (;).
\end{itemize}

\hypertarget{define-the-analyses-settings}{%
\section{Define the analyses
settings}\label{define-the-analyses-settings}}

The \texttt{CohortMethod} package allows multiple analyses settings to
be specified, as described in the
\texttt{Multiple\ analyses\ using\ CohortMethod} vignette. For example,
we can define a primary analysis (e.g.~using propensity score matching
and an on-treatment time-at-risk definition), and we can additionally
define sensitivity analyses (e.g.~using propensity score stratification
and an intent-to-treat time=at=risk definition). Note that
\texttt{CohortMethod} will execute all analyses on all
target-comparator-outcomes of interest.

We can create these settings and store them in our package. You can
modify the file \texttt{extras/CreateStudyAnalysisDetails.R} to create
the desired study design settings, and use the code below to execute
this code, which can also be found in \texttt{PackageMaintenance.R}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source}\NormalTok{(}\StringTok{"extras/CreateStudyAnalysisDetails.R"}\NormalTok{)}
\KeywordTok{createAnalysesDetails}\NormalTok{(}\StringTok{"inst/settings/"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{positive-control-synthesis}{%
\section{Positive control synthesis}\label{positive-control-synthesis}}

In addition to negative controls, where the true effect size is believed
to be a relative risk of 1, we can also include positive controls, where
the true effect has a known magnitude unequal to 1. These positive
controls can be used together with the negative controls to perform
confidence inteval calibration. We can automatically synthesize positive
controls by taking negative controls and adding simulated outcomes
during the time at risk. To preserve (measured) confounding, these
simulated outcomes should be sampled from the baseline probabilities
based on the patients' characteristics.

Positive control synthesis is implemented in the
\texttt{MethodEvaluation} package, and is called from the skeleton
package. However, it is necessary to configure it correctly, in the file
called \texttt{SynthesizePositiveControls.R} file. Most importantly, the
\texttt{washoutPeriod}, \texttt{riskWindowStart},
\texttt{riskWindowEnd}, \texttt{addExposureDaysToEnd}, and
\texttt{removePeopleWithPriorOutcomes} arguments need to be specified to
match those in the primary analysis. It is also possible to disable
positive control sysnthesis altogether by setting the
\texttt{skipSynthesis} variable to \texttt{TRUE}. Note that even if you
set \texttt{skipSynthesis\ \textless{}-\ TRUE}, you still need to use
\texttt{synthesizePositiveControls\ =\ TRUE} when running
\texttt{execute}.


\end{document}
